<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zombie Survival Game</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #2c3e50;
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            color: #ecf0f1;
        }

        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            border: 5px solid #bdc3c7;
            border-radius: 15px;
            overflow: hidden;
            background-color: #34495e;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }

        canvas {
            display: block;
            background-color: #2c3e50;
        }

        .game-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            text-align: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-menu.active {
            opacity: 1;
            visibility: visible;
        }

        .game-menu h1 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #e74c3c;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
        }

        .game-menu h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #f39c12;
        }

        .game-menu button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: 15px;
            box-shadow: 0 5px 0 #229a50;
        }

        .game-menu button:hover {
            background-color: #2ecc71;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #229a50;
        }

        .game-menu button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #229a50;
        }

        .gun-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .gun-card {
            background-color: #34495e;
            border: 3px solid #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            width: 150px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
            text-align: left;
        }

        .gun-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.2em;
            color: #3498db;
        }

        .gun-card p {
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .gun-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.7);
        }

        .gun-card.selected {
            border-color: #e74c3c;
            transform: scale(1.05);
            box-shadow: 0 15px 25px rgba(231, 76, 60, 0.6);
        }

        .gun-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
            color: #ecf0f1;
        }

        #gameScore, #gameHealth, #grenadeCount, #currentWeaponDisplay, #waveDisplay, #ammoDisplay, #zombiesLeftDisplay {
            position: absolute;
            font-size: 1.2em;
            color: #ecf0f1;
            z-index: 5;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        #waveDisplay {
            top: 10px;
            left: 10px;
        }

        #zombiesLeftDisplay {
            top: 40px;
            left: 10px;
        }

        #grenadeCount {
            top: 70px;
            left: 10px;
        }

        #gameScore {
            top: 100px;
            left: 10px;
        }

        #gameHealth {
            top: 10px;
            right: 10px;
            left: unset;
        }

        #currentWeaponDisplay {
            top: 130px;
            left: 10px;
            font-size: 1em;
            color: #f1c40f;
        }

        #ammoDisplay {
            top: 160px;
            left: 10px;
            font-size: 1em;
            color: #3498db;
        }

        #messageBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            border: 3px solid #e74c3c;
            border-radius: 10px;
            padding: 30px;
            font-size: 1.5em;
            color: #ecf0f1;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            display: none;
        }

        #controlModeSelection {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 5px;
        }

        #controlModeSelection button {
            background-color: #34495e;
            color: #ecf0f1;
            border: 2px solid #bdc3c7;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        #controlModeSelection button.selected-control {
            background-color: #27ae60;
            border-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
        }

        #controlModeSelection button:hover {
            background-color: #5d6d7e;
        }


        #mobileControls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
            z-index: 8;
        }

        .virtual-joystick, .fire-button {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(127, 140, 141, 0.5);
            border: 2px solid #bdc3c7;
            touch-action: none;
            pointer-events: auto;
        }

        .virtual-joystick {
            width: 120px;
            height: 120px;
        }

        .joystick-stick {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: rgba(189, 195, 199, 0.7);
            border-radius: 50%;
            border: 2px solid #ecf0f1;
        }

        .fire-button {
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(231, 76, 60, 0.5);
            border: 2px solid #e74c3c;
            color: #ecf0f1;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        /* Style for the knife attack visual effect */
        .knife-effect {
            position: absolute;
            border: 3px solid rgba(255, 255, 0, 0.8);
            border-radius: 50%;
            background-color: rgba(255, 255, 0, 0.2);
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
            opacity: 0;
            pointer-events: none; /* Ensure it doesn't block other inputs */
            transform: scale(0);
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <!-- Start Menu -->
        <div id="startMenu" class="game-menu active">
            <h1>ZOMBIE ONSLAUGHT</h1>
            <h2>SELECT YOUR WEAPON</h2>
            <div class="gun-selection">
                <div class="gun-card" data-gun="pistol">
                    <i class="fas fa-hand-pistol gun-icon"></i>
                    <h3>Pistol</h3>
                    <p>Damage: 20</p>
                    <p>Fire Rate: 300ms</p>
                    <p>Bullet Speed: 7</p>
                    <p>Ammo: 100</p>
                </div>
                <div class="gun-card" data-gun="shotgun">
                    <i class="fas fa-pump-medical gun-icon"></i>
                    <h3>Shotgun</h3>
                    <p>Damage: 50</p>
                    <p>Fire Rate: 800ms</p>
                    <p>Bullet Speed: 5</p>
                    <p>Ammo: 1000</p>
                </div>
                <div class="gun-card" data-gun="assaultRifle">
                    <i class="fas fa-rifle gun-icon"></i>
                    <h3>Assault Rifle</h3>
                    <p>Damage: 15</p>
                    <p>Fire Rate: 100ms</p>
                    <p>Bullet Speed: 9</p>
                    <p>Ammo: 300</p>
                </div>
                <!-- New Knife weapon card -->
                <div class="gun-card" data-gun="knife">
                    <i class="fas fa-knife gun-icon"></i>
                    <h3>Knife</h3>
                    <p>Damage: 70</p>
                    <p>Cooldown: 1.5s</p>
                    <p>Range: Melee</p>
                    <p>Ammo: Infinite</p>
                </div>
            </div>
            <div id="controlModeSelection">
                <button id="pcModeButton" class="selected-control">PC Mode</button>
                <!-- REMOVED: <button id="mobileModeButton">Mobile Mode</button> -->
            </div>
            <button id="startGameButton" disabled>START GAME</button>
        </div>

        <!-- Game Over Menu -->
        <div id="gameOverMenu" class="game-menu">
            <h1>GAME OVER!</h1>
            <h2>You survived for <span id="finalScore">0</span> waves!</h2>
            <button id="restartGameButton">RESTART</button>
        </div>

        <div id="waveDisplay">Wave: 0</div>
        <div id="zombiesLeftDisplay">Zombies Left: --</div>
        <div id="grenadeCount">Grenades: 3</div>
        <div id="gameScore">Score: 0</div>
        <div id="gameHealth">Health: 100</div>
        <div id="currentWeaponDisplay">Weapon: Pistol</div>
        <div id="ammoDisplay">Ammo: -- / --</div>

        <div id="messageBox"></div>

        <!-- Mobile Controls Overlay -->
        <div id="mobileControls">
            <div id="joystickBase" class="virtual-joystick">
                <div id="joystickStick" class="joystick-stick"></div>
            </div>
            <div id="fireButton" class="fire-button">FIRE</div>
        </div>
        <!-- Element for knife attack visual effect -->
        <div id="knifeEffect" class="knife-effect"></div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // Canvas and Context setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Game Constants ---
        const GRENADE_SPEED = 10;
        const GRENADE_RADIUS = 8;
        const GRENADE_EXPLOSION_DELAY = 2000;
        const GRENADE_EXPLOSION_RADIUS = 100;
        const GRENADE_DAMAGE = 80;
        const GRENADE_FRICTION = 0.98;

        const POWERUP_BOX_WIDTH = 40;
        const POWERUP_BOX_HEIGHT = 40;
        const POWERUP_BOX_HEALTH = 200;
        const POWERUP_BOX_DROP_SPEED = 0.5;
        const MIN_POWERUP_SPAWN_INTERVAL = 5000;
        const MAX_POWERUP_SPAWN_INTERVAL = 10000;

        const COLLECTABLE_SPEED = 15;
        const COLLECTABLE_EXPLOSION_RADIUS = 30;
        const COLLECTABLE_EXPLOSION_DAMAGE = 10;
        const COLLECTABLE_PUSH_FORCE = 30;

        const HEALTH_PACK_AMOUNT = 30;
        const GRENADE_REFILL_AMOUNT = 3;

        const ZOMBIE_RADIUS = 20;
        const ZOMBIE_MAX_HEALTH = 100;
        const ZOMBIE_BASE_SPEED = 0.5;
        const ZOMBIE_SPAWN_INTERVAL = 1000;
        const ZOMBIE_BITE_RADIUS = 25;
        const ZOMBIE_BITE_DAMAGE = 5; 
        const ZOMBIE_BITE_INTERVAL = 1000;
        const ZOMBIE_LEG_AMPLITUDE = 0.8;
        const ZOMBIE_LEG_SPEED = 0.05;

        const INTERMISSION_DURATION = 3000;

        // New Knife Constants
        const KNIFE_RADIUS = 70; // Visual radius of knife attack
        const KNIFE_COOLDOWN = 1500; // 1.5 seconds cooldown (client-side enforcement)
        const KNIFE_EFFECT_DURATION = 150; // How long the visual effect lasts in ms
        const KNIFE_DAMAGE = 70; // Damage applied by knife

        // --- Game State Variables ---
        let gameState = 'start';
        let score = 0; // Updated by server
        let playerHealth = 100; // Updated by server
        let grenadeCount = 3; // Client-side controlled for now
        let playerAmmo = 0; // Client-side controlled (refills sent by server via powerups)
        
        // Multiplayer state (managed by server and synced)
        let players = {}; // Stores all players including self
        let myPlayerId = null; // To easily reference this client's player object
        let zombies = {}; // Use an object for easier lookup by ID, updated by server
        let bullets = {}; // Use an object for easier lookup by ID, updated by server

        let keys = {};
        let mouse = { x: 0, y: 0, pressed: false, lastShotTime: 0 };

        let currentWave = 0; // Will be dictated by server (future waves)
        let zombiesToSpawnThisWave = 0; // Will be dictated by server (future waves)
        let zombiesSpawnedThisWave = 0; // Will be dictated by server (future waves)
        let zombiesKilledThisWave = 0; // Will be dictated by server (future waves)
        let waveInProgress = false; // Server dictates this
        let waveIntermission = false; // Server dictates this
        let intermissionStartTime = 0; // Server dictates this
        let lastZombieSpawnTime = 0; // Server dictates this
        let nextPowerUpSpawnTime = 0; // Client-side check, but powerups are server-triggered

        let controlMode = 'pc';
        let currentInputType = 'mouse';

        // Virtual Joystick and Fire Button for Mobile Controls
        const joystick = {
            baseX: 0,
            baseY: 0,
            baseRadius: 60,
            stickRadius: 30,
            active: false,
            touchId: null
        };

        const fireButtonState = {
            x: 0,
            y: 0,
            radius: 50,
            active: false,
            touchId: null
        };

        // 'player' variable now points to this client's data within the 'players' object
        // It will be assigned in socket.on('connect') or 'currentGameState'
        let player = { // Default structure, will be overwritten by server data
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 15,
            speed: 3,
            color: '#3498db',
            currentGun: null,
            mobileVx: 0,
            mobileVy: 0,
            lastKnifeTime: 0, // Client-side cooldown for visual/event throttling
            knifeEffectActive: false, // For local visual effect
            knifeEffectStartTime: 0
        };


        // UI Elements (references)
        const startMenu = document.getElementById('startMenu');
        const gameOverMenu = document.getElementById('gameOverMenu');
        const startGameButton = document.getElementById('startGameButton');
        const restartGameButton = document.getElementById('restartGameButton');
        const finalScoreSpan = document.getElementById('finalScore');
        const gameScoreDisplay = document.getElementById('gameScore');
        const gameHealthDisplay = document.getElementById('gameHealth');
        const grenadeCountDisplay = document.getElementById('grenadeCount');
        const currentWeaponDisplay = document.getElementById('currentWeaponDisplay');
        const waveDisplay = document.getElementById('waveDisplay');
        const ammoDisplay = document.getElementById('ammoDisplay');
        const zombiesLeftDisplay = document.getElementById('zombiesLeftDisplay');
        const gunCards = document.querySelectorAll('.gun-card');
        const messageBox = document.getElementById('messageBox');

        const pcModeButton = document.getElementById('pcModeButton');
        const mobileControlsDiv = document.getElementById('mobileControls');
        const joystickBaseElement = document.getElementById('joystickBase');
        const joystickStickElement = document.getElementById('joystickStick');
        const fireButtonElement = document.getElementById('fireButton');
        const knifeEffectElement = document.getElementById('knifeEffect'); // Reference to the knife effect div


        // Gun Configurations (client-side representation, server has authoritative versions)
        const guns = {
            pistol: {
                name: 'Pistol',
                damage: 20,
                fireRate: 300,
                bulletSpeed: 7,
                bulletColor: '#f39c12',
                bulletLength: 10,
                maxAmmo: 100,
                ammoPerShot: 1,
                icon: 'fas fa-hand-pistol',
                isMelee: false
            },
            shotgun: {
                name: 'Shotgun',
                damage: 50,
                fireRate: 800,
                bulletSpeed: 5,
                bulletColor: '#e67e22',
                bulletLength: 12,
                maxAmmo: 1000, 
                ammoPerShot: 5,
                icon: 'fas fa-pump-medical',
                isMelee: false
            },
            assaultRifle: {
                name: 'Assault Rifle',
                damage: 15,
                fireRate: 100,
                bulletSpeed: 9,
                bulletColor: '#f1c40f',
                bulletLength: 8,
                maxAmmo: 300,
                ammoPerShot: 1,
                icon: 'fas fa-rifle',
                isMelee: false
            },
            sonicBlaster: {
                name: 'Sonic Blaster',
                damage: 30,
                fireRate: 5,
                bulletSpeed: 25,
                bulletColor: '#8e44ad',
                bulletLength: 20,
                maxAmmo: 999999999999,
                ammoPerShot: 1,
                icon: 'fas fa-bolt',
                isMelee: false
            },
            knife: {
                name: 'Knife',
                damage: KNIFE_DAMAGE,
                cooldown: KNIFE_COOLDOWN, // Cooldown handled client-side for immediate feedback
                icon: 'fas fa-knife',
                isMelee: true, // Indicate it's a melee weapon
                maxAmmo: Infinity, // Infinite ammo for melee
                ammoPerShot: 0 // No ammo consumed
            },
            // New Omni-Blaster powerup gun
            omniBlaster: {
                name: 'Omni-Blaster',
                damage: 25, // Moderate damage per bullet
                fireRate: 200, // Fire a burst every 200ms
                bulletSpeed: 25, // Same speed as Sonic Blaster
                bulletColor: '#34d9eb', // Cyan-like color
                bulletLength: 15,
                maxAmmo: Infinity, // Infinite ammo, as it's a powerup
                ammoPerShot: 0, // No ammo consumed per shot
                icon: 'fas fa-circle', // Placeholder icon
                isMelee: false,
                bulletsPerShot: 16 // Number of bullets fired in a circle
            }
        };

        // Message Box Function
        function showMessage(message, duration = 2000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // --- Socket.IO Client Setup ---
        // IMPORTANT: Replace 'http://localhost:3000' with your actual deployed server URL!
        const socket = io('http://localhost:3000'); 

        socket.on('connect', () => {
            console.log('Connected to server with ID:', socket.id);
            myPlayerId = socket.id;
        });

        socket.on('currentGameState', (state) => {
            players = state.players;
            zombies = state.zombies;
            bullets = state.bullets;
            if (myPlayerId && players[myPlayerId]) {
                player = players[myPlayerId]; // Ensure 'player' refers to THIS client's data
                // Initialize client-side specific properties if they don't exist
                if (player.lastKnifeTime === undefined) player.lastKnifeTime = 0;
                if (player.knifeEffectActive === undefined) player.knifeEffectActive = false;
                if (player.knifeEffectStartTime === undefined) player.knifeEffectStartTime = 0;
            }
        });

        socket.on('newPlayer', (newPlayer) => {
            players[newPlayer.id] = newPlayer;
            // Initialize client-side specific properties for new players as well
            players[newPlayer.id].lastKnifeTime = 0;
            players[newPlayer.id].knifeEffectActive = false;
            players[newPlayer.id].knifeEffectStartTime = 0;
            console.log('New player joined:', newPlayer.id);
        });

        socket.on('playerDisconnected', (playerId) => {
            delete players[playerId];
            console.log('Player disconnected:', playerId);
        });

        socket.on('gameUpdate', (state) => {
            // Update local game state based on server's authoritative state
            players = state.players;
            zombies = state.zombies;
            bullets = state.bullets;

            // Ensure your local 'player' variable always points to your most recent data
            if (myPlayerId && players[myPlayerId]) {
                player = players[myPlayerId];
                gameHealthDisplay.textContent = `Health: ${Math.max(0, Math.floor(player.health))}`;
                gameScoreDisplay.textContent = `Score: ${player.score}`;
                // Grenades are client-side only for now, so don't overwrite from server
                grenadeCountDisplay.textContent = `Grenades: ${grenadeCount}`;
                
                // Update ammo display based on selected gun type
                if (player.currentGun && player.currentGun.isMelee) {
                    ammoDisplay.textContent = `Ammo: ∞`; // Infinite ammo for melee
                } else if (player.currentGun) {
                    ammoDisplay.textContent = `Ammo: ${playerAmmo} / ${player.currentGun.maxAmmo}`;
                } else {
                    ammoDisplay.textContent = `Ammo: -- / --`;
                }

            } else {
                if (gameState === 'playing') {
                    gameOver(); // If your player object no longer exists on server, game over
                }
            }
        });

        socket.on('playerHealthUpdate', (newHealth) => {
            if (myPlayerId && players[myPlayerId]) {
                players[myPlayerId].health = newHealth;
                gameHealthDisplay.textContent = `Health: ${Math.max(0, Math.floor(players[myPlayerId].health))}`;
            }
        });

        socket.on('playerScoreUpdate', (newScore) => {
            if (myPlayerId && players[myPlayerId]) {
                players[myPlayerId].score = newScore;
                gameScoreDisplay.textContent = `Score: ${players[myPlayerId].score}`;
            }
        });

        socket.on('newBullet', (bulletData) => {
            bullets[bulletData.id] = bulletData;
        });

        socket.on('removeBullet', (bulletId) => {
            delete bullets[bulletId];
        });

        socket.on('newZombie', (zombieData) => {
            zombies[zombieData.id] = zombieData;
        });

        socket.on('removeZombie', (zombieId) => {
            delete zombies[zombieId];
        });

        // Listen for knife effect broadcast from server (or from local trigger)
        socket.on('knifeEffect', (data) => {
            // Find the player who initiated the knife effect
            if (players[data.playerId]) {
                players[data.playerId].knifeEffectActive = true;
                players[data.playerId].knifeEffectStartTime = Date.now();
                // If it's this player, display the visual effect
                if (data.playerId === myPlayerId) {
                    knifeEffectElement.style.display = 'block';
                    // Position the effect around the player
                    const effectSize = KNIFE_RADIUS * 2; // Diameter
                    knifeEffectElement.style.width = `${effectSize}px`;
                    knifeEffectElement.style.height = `${effectSize}px`;
                    knifeEffectElement.style.left = `${player.x - KNIFE_RADIUS}px`;
                    knifeEffectElement.style.top = `${player.y - KNIFE_RADIUS}px`;
                    knifeEffectElement.style.opacity = '1';
                    knifeEffectElement.style.transform = 'scale(1)';

                    // Hide the effect after a short duration
                    setTimeout(() => {
                        knifeEffectElement.style.opacity = '0';
                        knifeEffectElement.style.transform = 'scale(0)';
                        knifeEffectElement.style.display = 'none';
                        if (players[data.playerId]) {
                            players[data.playerId].knifeEffectActive = false;
                        }
                    }, KNIFE_EFFECT_DURATION);
                }
            }
        });

        // Listen for powerup pickup event from the server
        socket.on('powerupPickedUp', (data) => {
            if (data.playerId === myPlayerId) {
                // Update the current gun on the client side
                player.currentGun = guns[data.gunType];
                playerAmmo = player.currentGun.maxAmmo; // Should be Infinity for Omni-Blaster
                currentWeaponDisplay.textContent = `Weapon: ${player.currentGun.name}`;
                ammoDisplay.textContent = player.currentGun.isMelee ? `Ammo: ∞` : `Ammo: ${playerAmmo} / ${player.currentGun.maxAmmo}`;
                showMessage(`Powerup: ${player.currentGun.name}!`, 2500);
            }
        });


        // --- Event Listeners (Client Input) ---
        window.addEventListener('keydown', (e) => {
            if (controlMode === 'pc' && gameState === 'playing') {
                keys[e.code] = true;
                if (e.code === 'KeyG') {
                    throwGrenade();
                }
                if (e.code === 'KeyM') { // New: Knife attack
                    performKnifeAttack();
                }
                if (e.code === 'KeyP') { // Temporary: Equip Omni-Blaster powerup
                    if (myPlayerId && players[myPlayerId]) {
                        players[myPlayerId].currentGun = guns['omniBlaster'];
                        player.currentGun = guns['omniBlaster'];
                        playerAmmo = guns['omniBlaster'].maxAmmo;
                        currentWeaponDisplay.textContent = `Weapon: ${player.currentGun.name}`;
                        ammoDisplay.textContent = `Ammo: ∞`;
                        showMessage("Omni-Blaster Acquired!", 1500);
                        // In a real game, you would emit a server event here
                        // socket.emit('powerupAcquired', { gunType: 'omniBlaster' });
                    }
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            if (controlMode === 'pc' && gameState === 'playing') {
                keys[e.code] = false;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (controlMode === 'pc' && gameState === 'playing') {
                const rect = canvas.getBoundingClientRect();
                mouse.x = e.clientX - rect.left;
                mouse.y = e.clientY - rect.top;
            }
        });

        canvas.addEventListener('mousedown', (e) => {
            if (controlMode === 'pc' && gameState === 'playing' && e.button === 0) {
                mouse.pressed = true;
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (controlMode === 'pc' && gameState === 'playing' && e.button === 0) {
                mouse.pressed = false;
            }
        });

        canvas.addEventListener('touchstart', (e) => {
            if (controlMode === 'mobile' && gameState === 'playing') {
                e.preventDefault();
                handleTouchStart(e);
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (controlMode === 'mobile' && gameState === 'playing') {
                e.preventDefault();
                handleTouchMove(e);
            }
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            if (controlMode === 'mobile' && gameState === 'playing') {
                handleTouchEnd(e);
            }
        });

        pcModeButton.addEventListener('click', () => {
            controlMode = 'pc';
            currentInputType = 'mouse';
            updateControlModeButtons();
            player.mobileVx = 0;
            player.mobileVy = 0;
            joystick.active = false;
            joystick.touchId = null;
            joystickStickElement.style.left = `${joystick.baseRadius - joystick.stickRadius}px`;
            joystickStickElement.style.top = `${joystick.baseRadius - joystick.stickRadius}px`;
            fireButtonState.active = false;
            fireButtonState.touchId = null;
            mobileControlsDiv.style.display = 'none';
        });

        startGameButton.addEventListener('click', () => {
            if (player.currentGun) {
                startGame();
            } else {
                showMessage("Please select a gun first!");
            }
        });

        restartGameButton.addEventListener('click', () => {
            initGame();
        });

        gunCards.forEach(card => {
            card.addEventListener('click', () => {
                gunCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                const selectedGunType = card.dataset.gun;
                // Update the local player's gun choice for UI/ammo display
                if (myPlayerId && players[myPlayerId]) {
                    // Do not allow selection of Omni-Blaster from the menu
                    if (selectedGunType === 'omniBlaster') {
                        showMessage("Omni-Blaster is a powerup, not a starting weapon!", 2000);
                        card.classList.remove('selected'); // Deselect if Omni-Blaster was accidentally clicked
                        startGameButton.disabled = true; // Keep button disabled if nothing else selected
                        player.currentGun = null; // Clear selected gun
                        currentWeaponDisplay.textContent = `Weapon: --`;
                        ammoDisplay.textContent = `Ammo: -- / --`;
                        return;
                    }
                    players[myPlayerId].currentGun = guns[selectedGunType]; // Assign the full gun object
                    player.currentGun = guns[selectedGunType]; // Update the client's player object

                    if (player.currentGun.isMelee) {
                        playerAmmo = Infinity; // Infinite ammo for knife
                        ammoDisplay.textContent = `Ammo: ∞`;
                    } else {
                        playerAmmo = player.currentGun.maxAmmo;
                        ammoDisplay.textContent = `Ammo: ${playerAmmo} / ${player.currentGun.maxAmmo}`;
                    }
                    
                    currentWeaponDisplay.textContent = `Weapon: ${player.currentGun.name}`;
                    startGameButton.disabled = false;
                    // Also inform the server about the gun change
                    socket.emit('playerChangeGun', { gunType: selectedGunType });
                }
            });
        });

        // --- Touch Control Logic (Unchanged for Knife) ---
        function handleTouchStart(e) {
            const canvasRect = canvas.getBoundingClientRect();

            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                const touchX = touch.clientX - canvasRect.left;
                const touchY = touch.clientY - canvasRect.top;

                const distToJoystickBaseCenter = Math.sqrt(Math.pow(touchX - joystick.baseX, 2) + Math.pow(touchY - joystick.baseY, 2));
                if (distToJoystickBaseCenter < joystick.baseRadius && !joystick.active) {
                    joystick.active = true;
                    joystick.touchId = touch.identifier;

                    let dx = touchX - joystick.baseX;
                    let dy = touchY - joystick.baseY;

                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance > joystick.baseRadius) {
                        dx *= (joystick.baseRadius / distance);
                        dy *= (joystick.baseRadius / distance);
                    }
                    
                    joystickStickElement.style.left = `${joystick.baseRadius + dx - joystick.stickRadius}px`;
                    joystickStickElement.style.top = `${joystick.baseRadius + dy - joystick.stickRadius}px`;

                    player.mobileVx = (dx / joystick.baseRadius) * player.speed;
                    player.mobileVy = (dy / joystick.baseRadius) * player.speed;

                    mouse.x = touchX;
                    mouse.y = touchY;
                }

                const distToFireButtonCenter = Math.sqrt(Math.pow(touchX - fireButtonState.x, 2) + Math.pow(touchY - fireButtonState.y, 2));
                if (distToFireButtonCenter < fireButtonState.radius && !fireButtonState.active) {
                    fireButtonState.active = true;
                    fireButtonState.touchId = touch.identifier;
                }
            }
        }

        function handleTouchMove(e) {
            const canvasRect = canvas.getBoundingClientRect();
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (joystick.active && joystick.touchId === touch.identifier) {
                    const touchX = touch.clientX - canvasRect.left;
                    const touchY = touch.clientY - canvasRect.top;

                    let dx = touchX - joystick.baseX;
                    let dy = touchY - joystick.baseY;

                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance > joystick.baseRadius) {
                        dx *= (joystick.baseRadius / distance);
                        dy *= (joystick.baseRadius / distance);
                    }

                    joystickStickElement.style.left = `${joystick.baseRadius + dx - joystick.stickRadius}px`;
                    joystickStickElement.style.top = `${joystick.baseRadius + dy - joystick.stickRadius}px`;

                    player.mobileVx = (dx / joystick.baseRadius) * player.speed;
                    player.mobileVy = (dy / joystick.baseRadius) * player.speed;

                    mouse.x = touchX;
                    mouse.y = touchY;
                }
            }
        }

        function handleTouchEnd(e) {
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (joystick.active && joystick.touchId === touch.identifier) {
                    joystick.active = false;
                    joystick.touchId = null;
                    joystickStickElement.style.left = `${joystick.baseRadius - joystick.stickRadius}px`;
                    joystickStickElement.style.top = `${joystick.baseRadius - joystick.stickRadius}px`;
                    player.mobileVx = 0;
                    player.mobileVy = 0;

                    mouse.x = player.x;
                    mouse.y = player.y;
                }
                if (fireButtonState.active && fireButtonState.touchId === touch.identifier) {
                    fireButtonState.active = false;
                    fireButtonState.touchId = null;
                }
            }
        }


        // --- Game Functions ---

        function initGame() {
            gameState = 'start';
            startMenu.classList.add('active');
            gameOverMenu.classList.remove('active');

            gameScoreDisplay.style.display = 'none';
            gameHealthDisplay.style.display = 'none';
            grenadeCountDisplay.style.display = 'none';
            currentWeaponDisplay.style.display = 'none';
            waveDisplay.style.display = 'none';
            ammoDisplay.style.display = 'none';
            zombiesLeftDisplay.style.display = 'none';
            mobileControlsDiv.style.display = 'none'; 
            knifeEffectElement.style.display = 'none'; // Hide knife effect at start
            player.knifeEffectActive = false; // Reset effect state
        }

        function startGame() {
            gameState = 'playing';
            startMenu.classList.remove('active');
            gameOverMenu.classList.remove('active');

            gameScoreDisplay.style.display = 'block';
            gameHealthDisplay.style.display = 'block';
            grenadeCountDisplay.style.display = 'block';
            currentWeaponDisplay.style.display = 'block';
            waveDisplay.style.display = 'block';
            ammoDisplay.style.display = 'block';
            zombiesLeftDisplay.style.display = 'block';

            // Reset client-side game state for a new game (server will also reset)
            score = 0;
            playerHealth = 100;
            grenadeCount = 3;
            // Ammo is set when gun is selected, but ensure it's correct at start
            if (player.currentGun && player.currentGun.isMelee) {
                playerAmmo = Infinity;
            } else if (player.currentGun) {
                playerAmmo = player.currentGun.maxAmmo;
            } else {
                 playerAmmo = 0; // Should not happen if start button is disabled
            }

            // Emit an event to the server to start the game
            socket.emit('startGame', { selectedGun: player.currentGun.name });

            // Initialize mobile controls if chosen, otherwise hide
            if (controlMode === 'mobile') {
                mobileControlsDiv.style.display = 'block';
                // Position joystick and fire button (adjust based on canvas size or desired layout)
                joystick.baseX = 100;
                joystick.baseY = canvas.height - 100;
                joystickBaseElement.style.left = `${joystick.baseX - joystick.baseRadius}px`;
                joystickBaseElement.style.top = `${joystick.baseY - joystick.baseRadius}px`;
                joystickStickElement.style.left = `${joystick.baseRadius - joystick.stickRadius}px`;
                joystickStickElement.style.top = `${joystick.baseRadius - joystick.stickRadius}px`;


                fireButtonState.x = canvas.width - 100;
                fireButtonState.y = canvas.height - 100;
                fireButtonElement.style.left = `${fireButtonState.x - fireButtonState.radius}px`;
                fireButtonElement.style.top = `${fireButtonState.y - fireButtonState.radius}px`;
            } else {
                mobileControlsDiv.style.display = 'none';
            }
            gameLoop();
        }

        function gameOver() {
            gameState = 'gameOver';
            gameOverMenu.classList.add('active');
            finalScoreSpan.textContent = currentWave; // Assuming currentWave reflects waves survived
            mobileControlsDiv.style.display = 'none'; // Hide mobile controls
            knifeEffectElement.style.display = 'none'; // Hide knife effect on game over
            player.knifeEffectActive = false; // Reset effect state
            socket.emit('gameOver');
        }

        function updateControlModeButtons() {
            pcModeButton.classList.toggle('selected-control', controlMode === 'pc');
            // mobileModeButton.classList.toggle('selected-control', controlMode === 'mobile');
        }

        function updatePlayerMovement() {
            if (!myPlayerId || !players[myPlayerId]) return;

            const myPlayer = players[myPlayerId];
            let vx = 0;
            let vy = 0;

            if (controlMode === 'pc') {
                if (keys['KeyW']) vy -= myPlayer.speed;
                if (keys['KeyS']) vy += myPlayer.speed;
                if (keys['KeyA']) vx -= myPlayer.speed;
                if (keys['KeyD']) vx += myPlayer.speed;
            } else if (controlMode === 'mobile') {
                vx = myPlayer.mobileVx;
                vy = myPlayer.mobileVy;
            }

            // Normalize diagonal movement
            if (vx !== 0 && vy !== 0) {
                const magnitude = Math.sqrt(vx * vx + vy * vy);
                vx = (vx / magnitude) * myPlayer.speed;
                vy = (vy / magnitude) * myPlayer.speed;
            }

            // Emit player movement to the server
            socket.emit('playerMovement', { vx, vy });
        }

        function updatePlayerShooting() {
            if (!myPlayerId || !players[myPlayerId]) return;

            const myPlayer = players[myPlayerId];
            const now = Date.now();
            const gun = myPlayer.currentGun ? guns[myPlayer.currentGun.name.toLowerCase()] : null;

            if (!gun) return; // No gun selected, cannot shoot

            // Check if it's a ranged weapon and if fire button/mouse is pressed
            if (!gun.isMelee && (mouse.pressed || fireButtonState.active)) {
                if (now - mouse.lastShotTime > gun.fireRate) {
                    if (gun.name === 'Omni-Blaster') {
                        // Omni-Blaster: shoots in a circle
                        const numBullets = gun.bulletsPerShot;
                        for (let i = 0; i < numBullets; i++) {
                            const angle = (Math.PI * 2 / numBullets) * i;
                            socket.emit('playerShoot', {
                                x: myPlayer.x,
                                y: myPlayer.y,
                                angle: angle,
                                gunType: gun.name.toLowerCase()
                            });
                        }
                    } else if (playerAmmo > 0) {
                        // Regular ranged weapon: shoots towards mouse
                        const angle = Math.atan2(mouse.y - myPlayer.y, mouse.x - myPlayer.x);
                        socket.emit('playerShoot', {
                            x: myPlayer.x,
                            y: myPlayer.y,
                            angle: angle,
                            gunType: gun.name.toLowerCase()
                        });
                        playerAmmo = Math.max(0, playerAmmo - gun.ammoPerShot); // Decrement client-side ammo
                        ammoDisplay.textContent = `Ammo: ${playerAmmo} / ${gun.maxAmmo}`;
                    } else {
                        showMessage("Out of Ammo!", 1000);
                        mouse.pressed = false; // Stop shooting if out of ammo
                        fireButtonState.active = false;
                    }
                    mouse.lastShotTime = now;
                }
            }
        }

        function throwGrenade() {
            if (!myPlayerId || !players[myPlayerId]) return;
            const myPlayer = players[myPlayerId];

            if (grenadeCount > 0) {
                // Calculate grenade direction based on mouse position
                const angle = Math.atan2(mouse.y - myPlayer.y, mouse.x - myPlayer.x);
                socket.emit('playerThrowGrenade', {
                    x: myPlayer.x,
                    y: myPlayer.y,
                    angle: angle
                });
                grenadeCount--;
                grenadeCountDisplay.textContent = `Grenades: ${grenadeCount}`;
            } else {
                showMessage("No Grenades left!", 1000);
            }
        }

        function performKnifeAttack() {
            if (!myPlayerId || !players[myPlayerId]) return;
            const myPlayer = players[myPlayerId];
            const now = Date.now();

            // Ensure the selected weapon is knife
            if (!myPlayer.currentGun || myPlayer.currentGun.name !== 'Knife') {
                showMessage("You need to select the Knife!", 1000);
                return;
            }

            // Check client-side cooldown
            if (now - myPlayer.lastKnifeTime > KNIFE_COOLDOWN) {
                myPlayer.lastKnifeTime = now;
                // Emit knife attack event to the server
                socket.emit('playerKnifeAttack', { playerId: myPlayerId });

                // Trigger local visual effect immediately
                myPlayer.knifeEffectActive = true;
                myPlayer.knifeEffectStartTime = now;
                knifeEffectElement.style.display = 'block';
                const effectSize = KNIFE_RADIUS * 2; // Diameter
                knifeEffectElement.style.width = `${effectSize}px`;
                knifeEffectElement.style.height = `${effectSize}px`;
                knifeEffectElement.style.left = `${myPlayer.x - KNIFE_RADIUS}px`;
                knifeEffectElement.style.top = `${myPlayer.y - KNIFE_RADIUS}px`;
                knifeEffectElement.style.opacity = '1';
                knifeEffectElement.style.transform = 'scale(1)';

                // Hide the effect after a short duration
                setTimeout(() => {
                    knifeEffectElement.style.opacity = '0';
                    knifeEffectElement.style.transform = 'scale(0)';
                    knifeEffectElement.style.display = 'none';
                    if (players[myPlayerId]) { // Check if player still exists
                        players[myPlayerId].knifeEffectActive = false;
                    }
                }, KNIFE_EFFECT_DURATION);
            } else {
                showMessage("Knife on cooldown!", 1000);
            }
        }


        // --- Drawing Functions ---

        function drawPlayer(p) {
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();

            // Draw player orientation (where they are looking/shooting)
            if (myPlayerId && p.id === myPlayerId) {
                let angle;
                // If Omni-Blaster, direction is not relevant for single-target aim
                if (p.currentGun && p.currentGun.name === 'Omni-Blaster') {
                    // Omni-Blaster doesn't need a specific aim line
                } else if (controlMode === 'pc') {
                    angle = Math.atan2(mouse.y - p.y, mouse.x - p.x);
                } else { // Mobile mode, use joystick input for direction if active
                    if (joystick.active && (player.mobileVx !== 0 || player.mobileVy !== 0)) {
                        angle = Math.atan2(player.mobileVy, player.mobileVx);
                    } else {
                        // Default to looking right if no movement input
                        angle = 0; 
                    }
                }
                // Only draw aiming line if not Omni-Blaster
                if (!p.currentGun || p.currentGun.name !== 'Omni-Blaster') {
                    const lineLength = p.radius + 10;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + Math.cos(angle) * lineLength, p.y + Math.sin(angle) * lineLength);
                    ctx.strokeStyle = '#ecf0f1';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.closePath();
                }
            }

            // Draw player ID
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '8px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText(p.id.substring(0, 4), p.x, p.y - p.radius - 5); // Display first 4 chars of ID
        }

        function drawZombie(z) {
            ctx.beginPath();
            ctx.arc(z.x, z.y, z.radius, 0, Math.PI * 2);
            ctx.fillStyle = z.color;
            ctx.fill();
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.closePath();

            // Draw health bar
            const healthBarWidth = 30;
            const healthBarHeight = 5;
            const healthPercentage = z.health / ZOMBIE_MAX_HEALTH;
            ctx.fillStyle = '#c0392b'; // Red for missing health
            ctx.fillRect(z.x - healthBarWidth / 2, z.y - z.radius - healthBarHeight - 5, healthBarWidth, healthBarHeight);
            ctx.fillStyle = '#2ecc71'; // Green for current health
            ctx.fillRect(z.x - healthBarWidth / 2, z.y - z.radius - healthBarHeight - 5, healthBarWidth * healthPercentage, healthBarHeight);
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 1;
            ctx.strokeRect(z.x - healthBarWidth / 2, z.y - z.radius - healthBarHeight - 5, healthBarWidth, healthBarHeight);

            // Draw zombie legs for walking animation (client-side visual flair)
            const legLength = z.radius * 0.8;
            const legAngleOffset = Math.sin(Date.now() * ZOMBIE_LEG_SPEED) * ZOMBIE_LEG_AMPLITUDE;

            // Simple movement direction for legs
            let moveAngle = 0;
            if (z.vx !== 0 || z.vy !== 0) {
                moveAngle = Math.atan2(z.vy, z.vx);
            }

            // Left leg
            ctx.beginPath();
            ctx.moveTo(z.x, z.y);
            ctx.lineTo(z.x + Math.cos(moveAngle + legAngleOffset) * legLength, z.y + Math.sin(moveAngle + legAngleOffset) * legLength);
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Right leg
            ctx.beginPath();
            ctx.moveTo(z.x, z.y);
            ctx.lineTo(z.x + Math.cos(moveAngle - legAngleOffset) * legLength, z.y + Math.sin(moveAngle - legAngleOffset) * legLength);
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        function drawBullet(b) {
            ctx.beginPath();
            if (b.gunType === 'shotgun') {
                // Shotgun bullets can be larger or multiple pellets
                ctx.rect(b.x - b.length / 2, b.y - b.length / 4, b.length, b.length / 2);
                ctx.fillStyle = b.color;
                ctx.fill();
            } else {
                ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                ctx.fillStyle = b.color;
                ctx.fill();
            }
            ctx.closePath();
        }

        function updateUI() {
            if (!myPlayerId || !players[myPlayerId]) return;

            // Update UI elements based on the local client's state.
            // Game score, health, etc. are updated via socket.on('gameUpdate') and specific updates from server.
            // But if there's a delay, we want to ensure immediate feedback on client-side ammo/grenades.

            waveDisplay.textContent = `Wave: ${currentWave}`;
            zombiesLeftDisplay.textContent = `Zombies Left: ${Object.keys(zombies).length}`;
            grenadeCountDisplay.textContent = `Grenades: ${grenadeCount}`;
            
            // Check if player.currentGun is defined before accessing its properties
            if (player.currentGun) {
                currentWeaponDisplay.textContent = `Weapon: ${player.currentGun.name}`;
                if (player.currentGun.isMelee || player.currentGun.name === 'Omni-Blaster') { // Omni-Blaster has infinite ammo
                    ammoDisplay.textContent = `Ammo: ∞`;
                } else {
                    ammoDisplay.textContent = `Ammo: ${playerAmmo} / ${player.currentGun.maxAmmo}`;
                }
            } else {
                currentWeaponDisplay.textContent = `Weapon: --`;
                ammoDisplay.textContent = `Ammo: -- / --`;
            }

            // Update knife effect visibility (controlled by socket.on('knifeEffect'))
            // This is primarily for visual feedback on the local client
            const now = Date.now();
            if (player.knifeEffectActive && (now - player.knifeEffectStartTime) < KNIFE_EFFECT_DURATION) {
                knifeEffectElement.style.display = 'block';
                knifeEffectElement.style.opacity = '1';
                knifeEffectElement.style.transform = 'scale(1)';
            } else {
                knifeEffectElement.style.opacity = '0';
                knifeEffectElement.style.transform = 'scale(0)';
                knifeEffectElement.style.display = 'none';
                player.knifeEffectActive = false; // Ensure it's false when effect ends
            }
        }


        // --- Main Game Loop ---

        function gameLoop() {
            if (gameState !== 'playing') {
                // Only request animation frame if game is playing
                // This prevents the loop from running when in menu or game over state
                return; 
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

            // Update client-side player movement and shooting
            updatePlayerMovement();
            updatePlayerShooting();

            // Draw all bullets
            for (const bulletId in bullets) {
                drawBullet(bullets[bulletId]);
            }

            // Draw all zombies
            for (const zombieId in zombies) {
                drawZombie(zombies[zombieId]);
            }

            // Draw all players
            for (const playerId in players) {
                drawPlayer(players[playerId]);
            }

            updateUI(); // Update UI elements

            requestAnimationFrame(gameLoop); // Continue the loop
        }

        // Initialize the game when the window loads
        window.onload = function() {
            initGame();
        };

    </script>
</body>
</html>
