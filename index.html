<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zombie Survival Game (Single Player)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #2c3e50;
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            color: #ecf0f1;
        }

        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            border: 5px solid #bdc3c7;
            border-radius: 15px;
            overflow: hidden;
            background-color: #34495e;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }

        canvas {
            display: block;
            background-color: #2c3e50;
        }

        .game-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            text-align: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            padding: 10px;
            box-sizing: border-box;
        }

        .game-menu.active {
            opacity: 1;
            visibility: visible;
        }

        .game-menu h1 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #e74c3c;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
        }

        .game-menu h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #f39c12;
        }

        .game-menu button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: 15px;
            box-shadow: 0 5px 0 #229a50;
        }

        .game-menu button:hover {
            background-color: #2ecc71;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #229a50;
        }

        .game-menu button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #229a50;
        }

        .gun-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .gun-card {
            background-color: #34495e;
            border: 3px solid #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            width: 130px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.5);
            text-align: left;
        }

        .gun-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.2em;
            color: #3498db;
        }

        .gun-card p {
            font-size: 0.8em;
            margin-bottom: 4px;
        }

        .gun-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.7);
        }

        .gun-card.selected {
            border-color: #e74c3c;
            transform: scale(1.05);
            box-shadow: 0 15px 25px rgba(231, 76, 60, 0.6);
        }

        .gun-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
            color: #ecf0f1;
        }

        #gameScore, #gameHealth, #grenadeCount, #currentWeaponDisplay, #waveDisplay, #ammoDisplay, #zombiesLeftDisplay {
            position: absolute;
            font-size: 1.2em;
            color: #ecf0f1;
            z-index: 5;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        #waveDisplay { top: 10px; left: 10px; }
        #zombiesLeftDisplay { top: 40px; left: 10px; }
        #grenadeCount { top: 70px; left: 10px; }
        #gameScore { top: 100px; left: 10px; }
        #gameHealth { top: 10px; right: 10px; left: unset; }
        #currentWeaponDisplay { top: 130px; left: 10px; font-size: 1em; color: #f1c40f; }
        #ammoDisplay { top: 160px; left: 10px; font-size: 1em; color: #3498db; }

        #messageBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            border: 3px solid #e74c3c;
            border-radius: 10px;
            padding: 30px;
            font-size: 1.5em;
            color: #ecf0f1;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            display: none;
        }

        #controlModeSelection {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 5px;
        }

        #controlModeSelection button {
            background-color: #34495e;
            color: #ecf0f1;
            border: 2px solid #bdc3c7;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        #controlModeSelection button.selected-control {
            background-color: #27ae60;
            border-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
        }

        #controlModeSelection button:hover {
            background-color: #5d6d7e;
        }


        #mobileControls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
            z-index: 8;
        }

        .virtual-joystick, .fire-button {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(127, 140, 141, 0.5);
            border: 2px solid #bdc3c7;
            touch-action: none;
            pointer-events: auto;
        }

        .virtual-joystick {
            width: 120px;
            height: 120px;
        }

        .joystick-stick {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: rgba(189, 195, 199, 0.7);
            border-radius: 50%;
            border: 2px solid #ecf0f1;
        }

        .fire-button {
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(231, 76, 60, 0.5);
            border: 2px solid #e74c3c;
            color: #ecf0f1;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        /* Style for the knife attack visual effect */
        .knife-effect {
            position: absolute;
            border: 3px solid rgba(255, 255, 0, 0.8);
            border-radius: 50%;
            background-color: rgba(255, 255, 0, 0.2);
            transition: transform 0.1s ease-out, opacity 0.1s ease-out;
            opacity: 0;
            pointer-events: none; /* Ensure it doesn't block other inputs */
            transform: scale(0);
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="startMenu" class="game-menu active">
            <h1>ZOMBIE ONSLAUGHT</h1>
            <h2>SELECT YOUR WEAPON</h2>
            <div class="gun-selection">
                <div class="gun-card" data-gun="pistol">
                    <i class="fas fa-gun gun-icon"></i>
                    <h3>Pistol</h3>
                    <p>Damage: 20</p>
                    <p>Fire Rate: 300ms</p>
                    <p>Bullet Speed: 7</p>
                    <p>Ammo: 100</p>
                </div>
                <div class="gun-card" data-gun="shotgun">
                    <i class="fas fa-crosshairs gun-icon"></i>
                    <h3>Shotgun</h3>
                    <p>Damage: 50</p>
                    <p>Fire Rate: 800ms</p>
                    <p>Bullet Speed: 5</p>
                    <p>Ammo: 1000</p>
                </div>
                <div class="gun-card" data-gun="assaultRifle">
                    <i class="fas fa-rifle gun-icon"></i>
                    <h3>Assault Rifle</h3>
                    <p>Damage: 15</p>
                    <p>Fire Rate: 100ms</p>
                    <p>Bullet Speed: 9</p>
                    <p>Ammo: 300</p>
                </div>
                <div class="gun-card" data-gun="knife">
                    <i class="fas fa-knife gun-icon"></i>
                    <h3>Knife</h3>
                    <p>Damage: 70</p>
                    <p>Cooldown: 1.5s</p>
                    <p>Range: Melee</p>
                    <p>Ammo: Infinite</p>
                </div>
            </div>
            <div id="controlModeSelection">
                <button id="pcModeButton" class="selected-control">PC Mode</button>
            </div>
            <button id="startGameButton" disabled>START GAME</button>
        </div>

        <div id="gameOverMenu" class="game-menu">
            <h1>GAME OVER!</h1>
            <h2>You survived for <span id="finalScore">0</span> waves!</h2>
            <button id="restartGameButton">RESTART</button>
        </div>

        <div id="waveDisplay">Wave: 0</div>
        <div id="zombiesLeftDisplay">Zombies Left: --</div>
        <div id="grenadeCount">Grenades: 3</div>
        <div id="gameScore">Score: 0</div>
        <div id="gameHealth">Health: 100</div>
        <div id="currentWeaponDisplay">Weapon: Pistol</div>
        <div id="ammoDisplay">Ammo: -- / --</div>

        <div id="messageBox"></div>

        <div id="mobileControls">
            <div id="joystickBase" class="virtual-joystick">
                <div id="joystickStick" class="joystick-stick"></div>
            </div>
            <div id="fireButton" class="fire-button">FIRE</div>
        </div>
        <div id="knifeEffect" class="knife-effect"></div>

    </div>

    <script>
        // Canvas and Context setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Game Constants (Client-Managed) ---
        const GRENADE_SPEED = 10;
        const GRENADE_RADIUS = 8;
        const GRENADE_EXPLOSION_DELAY = 2000;
        const GRENADE_EXPLOSION_RADIUS = 100;
        const GRENADE_DAMAGE = 80;
        const GRENADE_FRICTION = 0.98;

        const POWERUP_BOX_WIDTH = 40;
        const POWERUP_BOX_HEIGHT = 40;
        const POWERUP_BOX_HEALTH = 200;
        const POWERUP_BOX_DROP_SPEED = 0.5;
        const MIN_POWERUP_SPAWN_INTERVAL = 5000;
        const MAX_POWERUP_SPAWN_INTERVAL = 10000;

        const COLLECTABLE_SPEED = 15;
        const COLLECTABLE_EXPLOSION_RADIUS = 30;
        const COLLECTABLE_EXPLOSION_DAMAGE = 10;
        const COLLECTABLE_PUSH_FORCE = 30;

        const HEALTH_PACK_AMOUNT = 30;
        const GRENADE_REFILL_AMOUNT = 3;

        const ZOMBIE_RADIUS = 20;
        const ZOMBIE_MAX_HEALTH = 100;
        const ZOMBIE_BASE_SPEED = 0.5;
        const ZOMBIE_SPAWN_INTERVAL = 1000;
        const ZOMBIE_BITE_RADIUS = 25;
        const ZOMBIE_BITE_DAMAGE = 5;
        const ZOMBIE_BITE_INTERVAL = 1000;
        const ZOMBIE_LEG_AMPLITUDE = 0.8;
        const ZOMBIE_LEG_SPEED = 0.05;

        const INTERMISSION_DURATION = 3000;

        const KNIFE_RADIUS = 70;
        const KNIFE_COOLDOWN = 1500;
        const KNIFE_EFFECT_DURATION = 150;
        const KNIFE_DAMAGE = 70;

        // --- Game State Variables (All client-managed now) ---
        let gameState = 'start';
        let score = 0;
        let playerHealth = 100;
        let grenadeCount = 3;
        let playerAmmo = 0;
        let lastBiteTime = 0; // For zombie damage rate
        let lastShotTime = 0; // For player fire rate
        let lastPowerupSpawn = 0;

        // "Multiplayer" states converted to Single-Player
        let player = {
            id: 'localPlayer', // Give it a fixed ID
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 15,
            speed: 3,
            color: '#3498db',
            currentGun: null,
            mobileVx: 0,
            mobileVy: 0,
            lastKnifeTime: 0,
            knifeEffectActive: false,
            knifeEffectStartTime: 0,
            health: 100, // Added health back to player object for convenience
            score: 0,    // Added score back
        };

        let zombies = {}; // Stores all active zombies
        let bullets = {}; // Stores all active bullets
        let grenades = {}; // Stores active grenades
        let powerupBoxes = {}; // Stores active powerup boxes

        let keys = {};
        let mouse = { x: 0, y: 0, pressed: false };

        let currentWave = 0;
        let zombiesToSpawnThisWave = 0;
        let zombiesSpawnedThisWave = 0;
        let zombiesKilledThisWave = 0;
        let waveInProgress = false;
        let waveIntermission = false;
        let intermissionStartTime = 0;
        let lastZombieSpawnTime = 0;

        let controlMode = 'pc';
        let currentInputType = 'mouse';

        const joystick = {
            baseX: 0, baseY: 0, baseRadius: 60, stickRadius: 30, active: false, touchId: null
        };
        const fireButtonState = {
            x: 0, y: 0, radius: 50, active: false, touchId: null
        };

        // UI Elements (references) - remain the same
        const startMenu = document.getElementById('startMenu');
        const gameOverMenu = document.getElementById('gameOverMenu');
        const startGameButton = document.getElementById('startGameButton');
        const restartGameButton = document.getElementById('restartGameButton');
        const finalScoreSpan = document.getElementById('finalScore');
        const gameScoreDisplay = document.getElementById('gameScore');
        const gameHealthDisplay = document.getElementById('gameHealth');
        const grenadeCountDisplay = document.getElementById('grenadeCount');
        const currentWeaponDisplay = document.getElementById('currentWeaponDisplay');
        const waveDisplay = document.getElementById('waveDisplay');
        const ammoDisplay = document.getElementById('ammoDisplay');
        const zombiesLeftDisplay = document.getElementById('zombiesLeftDisplay');
        const gunCards = document.querySelectorAll('.gun-card');
        const messageBox = document.getElementById('messageBox');
        const pcModeButton = document.getElementById('pcModeButton');
        const mobileControlsDiv = document.getElementById('mobileControls');
        const joystickBaseElement = document.getElementById('joystickBase');
        const joystickStickElement = document.getElementById('joystickStick');
        const fireButtonElement = document.getElementById('fireButton');
        const knifeEffectElement = document.getElementById('knifeEffect');

        // Gun Configurations - remain the same
        const guns = {
            pistol: { name: 'Pistol', damage: 20, fireRate: 300, bulletSpeed: 7, bulletColor: '#f39c12', bulletLength: 10, maxAmmo: 100, ammoPerShot: 1, icon: 'fas fa-gun', isMelee: false },
            shotgun: { name: 'Shotgun', damage: 50, fireRate: 800, bulletSpeed: 5, bulletColor: '#e67e22', bulletLength: 12, maxAmmo: 1000, ammoPerShot: 5, icon: 'fas fa-crosshairs', isMelee: false },
            assaultRifle: { name: 'Assault Rifle', damage: 15, fireRate: 100, bulletSpeed: 9, bulletColor: '#f1c40f', bulletLength: 8, maxAmmo: 300, ammoPerShot: 1, icon: 'fas fa-rifle', isMelee: false },
            knife: { name: 'Knife', damage: KNIFE_DAMAGE, cooldown: KNIFE_COOLDOWN, icon: 'fas fa-knife', isMelee: true, maxAmmo: Infinity, ammoPerShot: 0 },
            omniBlaster: { name: 'Omni-Blaster', damage: 25, fireRate: 200, bulletSpeed: 25, bulletColor: '#34d9eb', bulletLength: 15, maxAmmo: Infinity, ammoPerShot: 0, icon: 'fas fa-circle', isMelee: false, bulletsPerShot: 16 }
        };

        // Utility function for collision detection
        function checkCollision(obj1, obj2) {
            const dx = obj1.x - obj2.x;
            const dy = obj1.y - obj2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < obj1.radius + obj2.radius;
        }

        // Generate a unique ID for local entities
        let entityIdCounter = 0;
        function generateId() {
            return `local-${entityIdCounter++}`;
        }

        // --- Game Logic Functions (Adapted from Server/Client) ---

        function spawnZombie() {
            if (zombiesSpawnedThisWave >= zombiesToSpawnThisWave) return;

            // Simple wave function: Increase zombie speed and health per wave
            const waveMultiplier = 1 + (currentWave - 1) * 0.1;
            const newZombie = {
                id: generateId(),
                x: Math.random() < 0.5 ? (Math.random() < 0.5 ? -ZOMBIE_RADIUS : canvas.width + ZOMBIE_RADIUS) : (player.x < canvas.width / 2 ? canvas.width + ZOMBIE_RADIUS : -ZOMBIE_RADIUS),
                y: Math.random() * canvas.height,
                radius: ZOMBIE_RADIUS,
                health: ZOMBIE_MAX_HEALTH * waveMultiplier,
                maxHealth: ZOMBIE_MAX_HEALTH * waveMultiplier,
                speed: ZOMBIE_BASE_SPEED * waveMultiplier,
                color: '#27ae60',
                lastBite: Date.now(),
                legOffset: 0
            };

            // Randomly position on the edges of the map
            if (Math.random() < 0.5) { // Spawn on top/bottom
                newZombie.x = Math.random() * canvas.width;
                newZombie.y = Math.random() < 0.5 ? -ZOMBIE_RADIUS : canvas.height + ZOMBIE_RADIUS;
            } else { // Spawn on left/right
                newZombie.x = Math.random() < 0.5 ? -ZOMBIE_RADIUS : canvas.width + ZOMBIE_RADIUS;
                newZombie.y = Math.random() * canvas.height;
            }

            zombies[newZombie.id] = newZombie;
            zombiesSpawnedThisWave++;
        }

        function nextWave() {
            currentWave++;
            waveInProgress = true;
            waveIntermission = false;
            intermissionStartTime = 0;
            zombiesKilledThisWave = 0;
            
            // Wave calculation (simple linear increase)
            zombiesToSpawnThisWave = 5 + currentWave * 3;
            zombiesSpawnedThisWave = 0;
            lastZombieSpawnTime = Date.now();
            lastPowerupSpawn = Date.now() + MIN_POWERUP_SPAWN_INTERVAL;

            showMessage(`Wave ${currentWave} Incoming!`, INTERMISSION_DURATION);
        }

        function gameOver() {
            gameState = 'gameOver';
            cancelAnimationFrame(gameLoopHandle);
            finalScoreSpan.textContent = currentWave;
            gameOverMenu.classList.add('active');
            mobileControlsDiv.style.display = 'none';
        }

        function startGame() {
            if (gameState !== 'start' || !player.currentGun) return;

            gameState = 'playing';
            startMenu.classList.remove('active');
            gameOverMenu.classList.remove('active');

            // Setup initial player state
            player.health = 100;
            player.score = 0;
            grenadeCount = 3;
            if (player.currentGun.isMelee) {
                playerAmmo = Infinity;
            } else {
                playerAmmo = player.currentGun.maxAmmo;
            }
            lastShotTime = 0;
            lastBiteTime = 0;
            
            // Start the first wave
            nextWave();
            
            // Start the game loop
            gameLoopHandle = requestAnimationFrame(gameLoop);
        }

        function initGame() {
            gameState = 'start';
            score = 0;
            playerHealth = 100;
            grenadeCount = 3;
            playerAmmo = 0;
            currentWave = 0;
            zombies = {};
            bullets = {};
            grenades = {};
            powerupBoxes = {};
            entityIdCounter = 0; // Reset ID counter
            
            // Reset player-specific state
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.health = 100;
            player.score = 0;
            player.lastKnifeTime = 0;
            
            // Update display
            gameScoreDisplay.textContent = 'Score: 0';
            gameHealthDisplay.textContent = 'Health: 100';
            grenadeCountDisplay.textContent = 'Grenades: 3';
            waveDisplay.textContent = 'Wave: 0';
            zombiesLeftDisplay.textContent = 'Zombies Left: --';
            currentWeaponDisplay.textContent = 'Weapon: --';
            ammoDisplay.textContent = 'Ammo: -- / --';

            startMenu.classList.add('active');
            gameOverMenu.classList.remove('active');

            player.currentGun = null;
            gunCards.forEach(c => c.classList.remove('selected'));
            startGameButton.disabled = true;
            
            // Ensure no rogue loop is running
            if (window.gameLoopHandle) {
                cancelAnimationFrame(window.gameLoopHandle);
            }
        }

        // --- Player Actions ---
        
        function fireBullet() {
            const now = Date.now();
            const gun = player.currentGun;
            
            if (!gun || gun.isMelee) return;

            if (playerAmmo < gun.ammoPerShot) {
                showMessage("OUT OF AMMO!", 500);
                return;
            }
            
            if (now - lastShotTime < gun.fireRate) {
                return;
            }

            // Shotgun fires multiple bullets
            if (gun.name === 'Shotgun') {
                const numPellets = 5;
                const spread = 0.5; // radians
                const dx = mouse.x - player.x;
                const dy = mouse.y - player.y;
                const baseAngle = Math.atan2(dy, dx);
                
                for (let i = 0; i < numPellets; i++) {
                    const angleOffset = (Math.random() - 0.5) * spread;
                    const bulletAngle = baseAngle + angleOffset;

                    bullets[generateId()] = {
                        id: generateId(),
                        x: player.x,
                        y: player.y,
                        vx: Math.cos(bulletAngle) * gun.bulletSpeed,
                        vy: Math.sin(bulletAngle) * gun.bulletSpeed,
                        damage: gun.damage,
                        radius: 5,
                        color: gun.bulletColor,
                        length: gun.bulletLength
                    };
                }
            } 
            // Omni-Blaster fires a circular burst
            else if (gun.name === 'Omni-Blaster') {
                const numBullets = gun.bulletsPerShot;
                for (let i = 0; i < numBullets; i++) {
                    const angle = (i * (2 * Math.PI)) / numBullets;
                    
                    bullets[generateId()] = {
                        id: generateId(),
                        x: player.x,
                        y: player.y,
                        vx: Math.cos(angle) * gun.bulletSpeed,
                        vy: Math.sin(angle) * gun.bulletSpeed,
                        damage: gun.damage,
                        radius: 5,
                        color: gun.bulletColor,
                        length: gun.bulletLength
                    };
                }
            }
            // Standard guns
            else {
                const dx = mouse.x - player.x;
                const dy = mouse.y - player.y;
                const angle = Math.atan2(dy, dx);
                
                bullets[generateId()] = {
                    id: generateId(),
                    x: player.x,
                    y: player.y,
                    vx: Math.cos(angle) * gun.bulletSpeed,
                    vy: Math.sin(angle) * gun.bulletSpeed,
                    damage: gun.damage,
                    radius: 5,
                    color: gun.bulletColor,
                    length: gun.bulletLength
                };
            }

            playerAmmo -= gun.ammoPerShot;
            lastShotTime = now;
        }
        
        function performKnifeAttack() {
            const now = Date.now();
            const gun = player.currentGun;

            if (gun.name !== 'Knife' || now - player.lastKnifeTime < KNIFE_COOLDOWN) {
                return;
            }

            player.lastKnifeTime = now;

            // Trigger the local visual effect
            knifeEffectElement.style.display = 'block';
            const effectSize = KNIFE_RADIUS * 2;
            knifeEffectElement.style.width = `${effectSize}px`;
            knifeEffectElement.style.height = `${effectSize}px`;
            knifeEffectElement.style.left = `${player.x - KNIFE_RADIUS}px`;
            knifeEffectElement.style.top = `${player.y - KNIFE_RADIUS}px`;
            knifeEffectElement.style.opacity = '1';
            knifeEffectElement.style.transform = 'scale(1)';

            setTimeout(() => {
                knifeEffectElement.style.opacity = '0';
                knifeEffectElement.style.transform = 'scale(0)';
                setTimeout(() => {
                    knifeEffectElement.style.display = 'none';
                }, 500);
            }, KNIFE_EFFECT_DURATION);

            // Knife collision check (Melee is client-side only in SP mode)
            for (const id in zombies) {
                const zombie = zombies[id];
                const dx = player.x - zombie.x;
                const dy = player.y - zombie.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < KNIFE_RADIUS + zombie.radius) {
                    // Apply damage
                    zombie.health -= KNIFE_DAMAGE;
                    if (zombie.health <= 0) {
                        delete zombies[id];
                        zombiesKilledThisWave++;
                        player.score += 10;
                    }
                }
            }
        }

        function throwGrenade() {
            if (grenadeCount <= 0) return;

            const dx = mouse.x - player.x;
            const dy = mouse.y - player.y;
            const angle = Math.atan2(dy, dx);
            
            grenadeCount--;
            grenadeCountDisplay.textContent = `Grenades: ${grenadeCount}`;

            const newGrenade = {
                id: generateId(),
                x: player.x,
                y: player.y,
                vx: Math.cos(angle) * GRENADE_SPEED,
                vy: Math.sin(angle) * GRENADE_SPEED,
                startTime: Date.now(),
                exploded: false,
                color: '#e74c3c'
            };
            grenades[newGrenade.id] = newGrenade;
        }

        // --- Collision and Update Logic (Moved from Server) ---

        function updatePlayerPosition() {
            let dx = 0;
            let dy = 0;

            if (controlMode === 'pc') {
                if (keys['KeyW'] || keys['ArrowUp']) dx = 0, dy = -player.speed;
                if (keys['KeyS'] || keys['ArrowDown']) dx = 0, dy = player.speed;
                if (keys['KeyA'] || keys['ArrowLeft']) dx = -player.speed, dy = 0;
                if (keys['KeyD'] || keys['ArrowRight']) dx = player.speed, dy = 0;

                // Diagonal movement normalization
                if (dx !== 0 && dy !== 0) {
                    const length = Math.sqrt(dx * dx + dy * dy);
                    dx = (dx / length) * player.speed;
                    dy = (dy / length) * player.speed;
                }
            } else { // Mobile controls
                dx = player.mobileVx;
                dy = player.mobileVy;
            }

            player.x += dx;
            player.y += dy;

            // Clamp player position within canvas bounds
            player.x = Math.max(player.radius, Math.min(canvas.width - player.radius, player.x));
            player.y = Math.max(player.radius, Math.min(canvas.height - player.radius, player.y));
        }

        function updateGameEntities() {
            const now = Date.now();

            // 1. Player Attack
            if (mouse.pressed && player.currentGun && !player.currentGun.isMelee) {
                fireBullet();
            } else if (mouse.pressed && player.currentGun && player.currentGun.name === 'Knife') {
                performKnifeAttack();
            }

            // 2. Update Bullets
            for (const id in bullets) {
                const bullet = bullets[id];
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;

                // Check boundary collision
                if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
                    delete bullets[id];
                    continue;
                }

                // Bullet-Zombie collision
                for (const zombieId in zombies) {
                    const zombie = zombies[zombieId];
                    const dist = Math.hypot(bullet.x - zombie.x, bullet.y - zombie.y);
                    if (dist < zombie.radius) {
                        zombie.health -= bullet.damage;
                        delete bullets[id]; // Bullet is destroyed
                        
                        if (zombie.health <= 0) {
                            delete zombies[zombieId];
                            zombiesKilledThisWave++;
                            player.score += 10;
                        }
                        break;
                    }
                }
            }

            // 3. Update Zombies
            for (const id in zombies) {
                const zombie = zombies[id];
                
                // Movement towards player
                const dx = player.x - zombie.x;
                const dy = player.y - zombie.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                const angle = Math.atan2(dy, dx);
                zombie.x += Math.cos(angle) * zombie.speed;
                zombie.y += Math.sin(angle) * zombie.speed;

                // Zombie-Player collision (Bite)
                if (distance < ZOMBIE_BITE_RADIUS + player.radius) {
                    if (now - zombie.lastBite > ZOMBIE_BITE_INTERVAL) {
                        player.health -= ZOMBIE_BITE_DAMAGE;
                        zombie.lastBite = now;
                        if (player.health <= 0) {
                            gameOver();
                        }
                    }
                }
                
                // Zombie leg animation
                zombie.legOffset = (zombie.legOffset + ZOMBIE_LEG_SPEED) % (2 * Math.PI);
            }
            
            // 4. Update Grenades
            for (const id in grenades) {
                const grenade = grenades[id];

                if (!grenade.exploded) {
                    // Apply velocity and friction
                    grenade.x += grenade.vx;
                    grenade.y += grenade.vy;
                    grenade.vx *= GRENADE_FRICTION;
                    grenade.vy *= GRENADE_FRICTION;

                    // Check for explosion time
                    if (now - grenade.startTime > GRENADE_EXPLOSION_DELAY) {
                        grenade.exploded = true;
                        // Explosion logic
                        for (const zombieId in zombies) {
                            const zombie = zombies[zombieId];
                            const dist = Math.hypot(grenade.x - zombie.x, grenade.y - zombie.y);
                            if (dist < GRENADE_EXPLOSION_RADIUS) {
                                // Simple distance-based damage falloff
                                const damageFactor = 1 - (dist / GRENADE_EXPLOSION_RADIUS);
                                zombie.health -= GRENADE_DAMAGE * damageFactor;
                                
                                if (zombie.health <= 0) {
                                    delete zombies[zombieId];
                                    zombiesKilledThisWave++;
                                    player.score += 10;
                                }
                            }
                        }
                        // Remove grenade after visual effect (next frame)
                    }
                } else {
                    delete grenades[id]; // Remove exploded grenade
                }
            }
            
            // 5. Update Powerup Boxes
            // (Skipped for simplicity in this conversion, would require full powerup box implementation)
        }
        
        function updateWaveState() {
            const now = Date.now();
            
            if (gameState !== 'playing') return;
            
            // Check for wave end
            if (waveInProgress && zombiesToSpawnThisWave > 0 && zombiesKilledThisWave === zombiesToSpawnThisWave && Object.keys(zombies).length === 0) {
                waveInProgress = false;
                waveIntermission = true;
                intermissionStartTime = now;
                showMessage(`Wave ${currentWave} Cleared! Preparing for Wave ${currentWave + 1}...`, INTERMISSION_DURATION);
            }
            
            // Handle intermission (if all zombies killed)
            if (waveIntermission && now - intermissionStartTime >= INTERMISSION_DURATION) {
                nextWave();
            }

            // Spawn zombies during wave
            if (waveInProgress && zombiesSpawnedThisWave < zombiesToSpawnThisWave) {
                if (now - lastZombieSpawnTime > ZOMBIE_SPAWN_INTERVAL) {
                    spawnZombie();
                    lastZombieSpawnTime = now;
                }
            }
            
            // Update UI displays
            waveDisplay.textContent = `Wave: ${currentWave}`;
            zombiesLeftDisplay.textContent = `Zombies Left: ${Math.max(0, zombiesToSpawnThisWave - zombiesKilledThisWave)}`;
            gameHealthDisplay.textContent = `Health: ${Math.max(0, Math.floor(player.health))}`;
            gameScoreDisplay.textContent = `Score: ${player.score}`;
            grenadeCountDisplay.textContent = `Grenades: ${grenadeCount}`;
            
            if (player.currentGun) {
                ammoDisplay.textContent = player.currentGun.isMelee ? `Ammo: ∞` : `Ammo: ${playerAmmo} / ${player.currentGun.maxAmmo}`;
            } else {
                 ammoDisplay.textContent = `Ammo: -- / --`;
            }

            // Powerup Spawning (Simple timer logic)
            if (now > lastPowerupSpawn) {
                // Implement powerup box spawning logic here if needed
                lastPowerupSpawn = now + MIN_POWERUP_SPAWN_INTERVAL + Math.random() * (MAX_POWERUP_SPAWN_INTERVAL - MIN_POWERUP_SPAWN_INTERVAL);
            }
        }
        
        // --- Drawing Functions (Remain mostly the same) ---
        
        function drawPlayer() {
            // Draw health bar
            const healthBarWidth = 30;
            const healthBarHeight = 5;
            const healthPercentage = player.health / 100;
            
            ctx.fillStyle = '#c0392b'; // Red background
            ctx.fillRect(player.x - healthBarWidth / 2, player.y - player.radius - 10, healthBarWidth, healthBarHeight);

            ctx.fillStyle = '#2ecc71'; // Green health
            ctx.fillRect(player.x - healthBarWidth / 2, player.y - player.radius - 10, healthBarWidth * healthPercentage, healthBarHeight);

            // Draw player body
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw direction/aim line (PC only)
            if (controlMode === 'pc') {
                const dx = mouse.x - player.x;
                const dy = mouse.y - player.y;
                const angle = Math.atan2(dy, dx);
                
                // Draw a simple gun line
                ctx.strokeStyle = '#f1c40f';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(player.x + Math.cos(angle) * player.radius * 2, player.y + Math.sin(angle) * player.radius * 2);
                ctx.stroke();
            }
        }

        function drawZombie(zombie) {
            // Draw health bar
            const healthBarWidth = 30;
            const healthBarHeight = 5;
            const healthPercentage = zombie.health / zombie.maxHealth;
            
            ctx.fillStyle = '#c0392b';
            ctx.fillRect(zombie.x - healthBarWidth / 2, zombie.y - zombie.radius - 10, healthBarWidth, healthBarHeight);
            
            ctx.fillStyle = '#f39c12'; // Orange/yellow zombie health
            ctx.fillRect(zombie.x - healthBarWidth / 2, zombie.y - zombie.radius - 10, healthBarWidth * healthPercentage, healthBarHeight);

            // Draw zombie body
            ctx.fillStyle = zombie.color;
            ctx.beginPath();
            ctx.arc(zombie.x, zombie.y, zombie.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Simple leg animation
            const legSize = zombie.radius * 0.4;
            ctx.fillStyle = '#34495e';
            ctx.beginPath();
            ctx.arc(zombie.x + Math.sin(zombie.legOffset) * ZOMBIE_LEG_AMPLITUDE * zombie.radius, 
                    zombie.y + zombie.radius - 2, legSize, 0, Math.PI * 2);
            ctx.arc(zombie.x - Math.sin(zombie.legOffset) * ZOMBIE_LEG_AMPLITUDE * zombie.radius, 
                    zombie.y + zombie.radius - 2, legSize, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw eyes
            ctx.fillStyle = '#c0392b';
            ctx.beginPath();
            ctx.arc(zombie.x - zombie.radius * 0.3, zombie.y - zombie.radius * 0.3, 3, 0, Math.PI * 2);
            ctx.arc(zombie.x + zombie.radius * 0.3, zombie.y - zombie.radius * 0.3, 3, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawBullet(bullet) {
            ctx.fillStyle = bullet.color;
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawGrenade(grenade) {
             ctx.fillStyle = grenade.exploded ? 'rgba(231, 76, 60, 0.5)' : grenade.color;
            
            if (grenade.exploded) {
                // Draw explosion radius
                ctx.beginPath();
                ctx.arc(grenade.x, grenade.y, GRENADE_EXPLOSION_RADIUS, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw grenade body
            ctx.fillStyle = grenade.color;
            ctx.beginPath();
            ctx.arc(grenade.x, grenade.y, GRENADE_RADIUS, 0, Math.PI * 2);
            ctx.fill();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

            if (gameState !== 'playing') return;

            // Draw Entities
            for (const id in grenades) { drawGrenade(grenades[id]); }
            for (const id in zombies) { drawZombie(zombies[id]); }
            for (const id in bullets) { drawBullet(bullets[id]); }
            drawPlayer();
        }

        // --- Main Game Loop ---
        let gameLoopHandle;
        let lastTime = 0;
        
        function gameLoop(currentTime) {
            if (gameState !== 'playing') return;

            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;

            // 1. Process Input and Update Player Position
            updatePlayerPosition();
            
            // 2. Update all Game Entities (Movement, Collisions, Damage)
            updateGameEntities();
            
            // 3. Game State Management (Waves, Scoring, Health Check)
            updateWaveState();

            // 4. Draw Everything
            draw();

            gameLoopHandle = requestAnimationFrame(gameLoop);
        }

        // --- Event Listeners (Removed Server-Emitting code) ---
        
        window.addEventListener('keydown', (e) => {
            if (controlMode === 'pc' && gameState === 'playing') {
                keys[e.code] = true;
                if (e.code === 'KeyG') {
                    throwGrenade();
                }
                if (e.code === 'KeyM') {
                    // Only perform knife attack on keydown for immediate feedback
                    performKnifeAttack();
                }
                if (e.code === 'KeyP') {
                    // Temporary Powerup acquire (now local)
                    player.currentGun = guns['omniBlaster'];
                    playerAmmo = guns['omniBlaster'].maxAmmo;
                    currentWeaponDisplay.textContent = `Weapon: ${player.currentGun.name}`;
                    ammoDisplay.textContent = `Ammo: ∞`;
                    showMessage("Omni-Blaster Acquired!", 1500);
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            if (controlMode === 'pc' && gameState === 'playing') {
                keys[e.code] = false;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (controlMode === 'pc' && gameState === 'playing') {
                const rect = canvas.getBoundingClientRect();
                mouse.x = e.clientX - rect.left;
                mouse.y = e.clientY - rect.top;
            }
        });

        canvas.addEventListener('mousedown', (e) => {
            if (controlMode === 'pc' && gameState === 'playing' && e.button === 0) {
                mouse.pressed = true;
                // Immediate fire for non-automatic weapons (or continuous fire in gameLoop)
                if (player.currentGun && (player.currentGun.fireRate > 200 || player.currentGun.isMelee)) {
                    // Small delay prevents double fire
                    if (Date.now() - lastShotTime > 100) { 
                        if (player.currentGun.isMelee) {
                            performKnifeAttack();
                        } else {
                            fireBullet();
                        }
                    }
                }
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (controlMode === 'pc' && gameState === 'playing' && e.button === 0) {
                mouse.pressed = false;
            }
        });

        // Touch handlers (simplified for single player, aiming logic removed)
        function handleTouchStart(e) { /* ... mobile logic ... */ }
        function handleTouchMove(e) { /* ... mobile logic ... */ }
        function handleTouchEnd(e) { /* ... mobile logic ... */ }

        // Start/Restart logic
        startGameButton.addEventListener('click', () => {
            if (player.currentGun) {
                // Removed: socket.emit('selectGun', ...)
                startGame();
            } else {
                showMessage("Please select a gun first!");
            }
        });

        restartGameButton.addEventListener('click', () => {
            initGame();
        });

        // Gun selection logic
        gunCards.forEach(card => {
            card.addEventListener('click', () => {
                gunCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                const selectedGunType = card.dataset.gun;
                
                if (selectedGunType === 'omniBlaster') {
                    showMessage("Omni-Blaster is a powerup, not a starting weapon!", 2000);
                    card.classList.remove('selected');
                    startGameButton.disabled = true;
                    player.currentGun = null;
                    currentWeaponDisplay.textContent = `Weapon: --`;
                    ammoDisplay.textContent = `Ammo: -- / --`;
                    return;
                }

                const gunConfig = guns[selectedGunType];
                player.currentGun = gunConfig; // Directly update player object

                // Set initial ammo
                playerAmmo = gunConfig.isMelee ? Infinity : gunConfig.maxAmmo;
                
                // Update UI
                currentWeaponDisplay.textContent = `Weapon: ${player.currentGun.name}`;
                ammoDisplay.textContent = player.currentGun.isMelee ? `Ammo: ∞` : `Ammo: ${playerAmmo} / ${player.currentGun.maxAmmo}`;
                startGameButton.disabled = false;
            });
        });

        pcModeButton.addEventListener('click', () => {
            controlMode = 'pc';
            currentInputType = 'mouse';
            pcModeButton.classList.add('selected-control');
            mobileControlsDiv.style.display = 'none';
        });

        // Initial setup
        initGame();
    </script>
</body>
</html>
